<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Appointment - Akash's Ayurvedic Pharmacy</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <style>
      select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #bdc3c7;
        border-radius: 6px;
        font-size: 1rem;
        background: white;
        cursor: pointer;
        transition: border-color 0.3s ease;
      }

      select:focus {
        outline: none;
        border-color: #2ecc71;
        box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
      }

      .appointment-form {
        display: none;
      }

      .appointment-form.show {
        display: block;
      }

      .otp-section {
        display: none;
        background: #f0f9ff;
        padding: 1.5rem;
        border-radius: 8px;
        border-left: 4px solid #2ecc71;
        margin-bottom: 1.5rem;
      }

      .otp-section.show {
        display: block;
      }

      .otp-input-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }

      #otpCode {
        max-width: 150px;
        padding: 0.75rem;
        border: 2px solid #2ecc71;
        border-radius: 6px;
        font-size: 1rem;
        letter-spacing: 4px;
        text-align: center;
      }

      .otp-timer {
        font-size: 0.9rem;
        color: #e74c3c;
        font-weight: 600;
        margin-top: 0.5rem;
      }

      .otp-timer.expired {
        color: #7f8c8d;
      }

      .btn-verify-otp,
      .btn-resend-otp {
        padding: 0.6rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-verify-otp {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
      }

      .btn-verify-otp:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
      }

      .btn-resend-otp {
        background: #ecf0f1;
        color: #7f8c8d;
        font-size: 0.9rem;
      }

      .btn-resend-otp:hover:not(:disabled) {
        background: #bdc3c7;
      }

      .btn-resend-otp:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .phone-info {
        background: #e8f8f5;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: #27ae60;
      }

      .notification {
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        display: none;
        animation: slideIn 0.3s ease;
      }

      .notification.show {
        display: block;
      }

      .notification.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .notification.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-10px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="logo">
          <h1>Akash's Ayurvedic Pharmacy</h1>
        </div>
      </div>
    </nav>

    <section class="section">
      <div class="container">
        <h2 class="section-title">Book an Appointment</h2>
        <div
          style="
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          "
        >
          <!-- Notification -->
          <div id="appointmentNotification" class="notification"></div>

          <!-- Step 1: Phone Number & OTP -->
          <div id="phoneVerificationSection">
            <h3 style="margin-bottom: 1.5rem; color: #2c3e50">
              Step 1: Verify Phone Number
            </h3>

            <div class="form-group">
              <label for="phoneNumber">Phone Number:</label>
              <input
                type="tel"
                id="phoneNumber"
                name="phone_number"
                placeholder="+91 98765 43210"
                required
              />
              <small style="color: #7f8c8d">
                Call 9230130888 to get the OTP
              </small>
            </div>

            <button
              type="button"
              class="btn btn-primary full-width"
              onclick="sendOTP()"
              style="margin-bottom: 1rem"
            >
              Send OTP
            </button>

            <!-- OTP Verification Section -->
            <div id="otpSection" class="otp-section">
              <div class="phone-info" id="phoneDisplay"></div>

              <div class="form-group">
                <label for="otpCode">Enter OTP:</label>
                <div class="otp-input-group">
                  <input
                    type="text"
                    id="otpCode"
                    name="otp_code"
                    placeholder="000000"
                    maxlength="6"
                    required
                  />
                  <button
                    type="button"
                    class="btn-verify-otp"
                    onclick="verifyOTP()"
                  >
                    Verify
                  </button>
                </div>
                <div class="otp-timer" id="otpTimer"></div>
              </div>

              <button
                type="button"
                class="btn-resend-otp"
                id="resendBtn"
                onclick="sendOTP()"
                disabled
                style="width: 100%; margin-top: 1rem"
              >
                Resend OTP (30s)
              </button>
            </div>
          </div>

          <!-- Step 2: Appointment Details (visible after OTP verification) -->
          <div id="appointmentFormSection" class="appointment-form">
            <h3 style="margin-bottom: 1.5rem; color: #2c3e50">
              Step 2: Appointment Details
            </h3>

            <form id="appointmentForm" onsubmit="submitAppointment(event)">
              <div class="form-group">
                <label for="name">Your Name:</label>
                <input type="text" id="name" name="customer_name" required />
              </div>

              <div class="form-group">
                <label for="doctor">Select Doctor:</label>
                <select id="doctor" name="doctor_id" required>
                  <option value="">-- Choose a Doctor --</option>
                </select>
              </div>

              <div class="form-group">
                <label for="date">Appointment Date & Time:</label>
                <input
                  type="datetime-local"
                  id="date"
                  name="appointment_date"
                  required
                />
              </div>

              <button type="submit" class="btn btn-primary full-width">
                Confirm Appointment
              </button>
            </form>
          </div>

          <a
            href="{% url 'home' %}"
            class="btn btn-secondary full-width"
            style="margin-top: 1rem; text-decoration: none"
            >Back to Home</a
          >
        </div>
      </div>
    </section>

    <script>
      // API Base URL
      const API_BASE = "/api";
      let otpResendTimer = null;
      let otpExpiryTimer = null;
      let currentPhoneNumber = "";
      let isPhoneVerified = false;

      // ========== Show Notification ==========
      function showNotification(message, type = "success") {
        const notification = document.getElementById("appointmentNotification");
        notification.textContent = message;
        notification.className = `notification ${type} show`;

        setTimeout(() => {
          notification.classList.remove("show");
        }, 4000);
      }

      // ========== Send OTP ==========
      function sendOTP() {
        const phoneNumber = document.getElementById("phoneNumber").value.trim();

        if (!phoneNumber) {
          showNotification("Please enter a phone number", "error");
          return;
        }

        if (phoneNumber.replace(/\D/g, "").length < 10) {
          showNotification(
            "Please enter a valid phone number (at least 10 digits)",
            "error",
          );
          return;
        }

        // Store phone number
        currentPhoneNumber = phoneNumber;

        // Disable send button
        const sendBtn = event.target;
        sendBtn.disabled = true;
        sendBtn.textContent = "Sending...";

        fetch(`${API_BASE}/send-otp/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ phone_number: phoneNumber }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              showNotification(data.error, "error");
              sendBtn.disabled = false;
              sendBtn.textContent = "Send OTP";
            } else {
              showNotification("OTP sent successfully!", "success");

              // Show OTP section
              document.getElementById("otpSection").classList.add("show");
              document.getElementById("phoneDisplay").innerHTML =
                `ðŸ“± OTP sent to: <strong>${phoneNumber}</strong>`;
              document.getElementById("phoneNumber").disabled = true;
              sendBtn.style.display = "none";

              // If otp_for_testing is provided, show it (remove in production)
              if (data.otp_for_testing) {
                console.log(`ðŸ§ª Testing OTP: ${data.otp_for_testing}`);
              }

              // Start resend timer
              startResendTimer();
              startOTPExpiryTimer();
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            showNotification("Failed to send OTP", "error");
            sendBtn.disabled = false;
            sendBtn.textContent = "Send OTP";
          });
      }

      // ========== Verify OTP ==========
      function verifyOTP() {
        const otpCode = document.getElementById("otpCode").value.trim();

        if (!otpCode || otpCode.length !== 6) {
          showNotification("Please enter a 6-digit OTP", "error");
          return;
        }

        const verifyBtn = event.target;
        verifyBtn.disabled = true;
        verifyBtn.textContent = "Verifying...";

        fetch(`${API_BASE}/verify-otp/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            phone_number: currentPhoneNumber,
            otp_code: otpCode,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              showNotification(data.error, "error");
              verifyBtn.disabled = false;
              verifyBtn.textContent = "Verify";
            } else {
              showNotification(
                "Phone number verified successfully!",
                "success",
              );
              isPhoneVerified = true;

              // Hide OTP section
              document.getElementById("otpSection").classList.remove("show");
              document.getElementById(
                "phoneVerificationSection",
              ).style.display = "none";

              // Show appointment form
              document
                .getElementById("appointmentFormSection")
                .classList.add("show");

              // Load doctors
              loadDoctors();

              // Clear timers
              clearInterval(otpResendTimer);
              clearInterval(otpExpiryTimer);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            showNotification("Failed to verify OTP", "error");
            verifyBtn.disabled = false;
            verifyBtn.textContent = "Verify";
          });
      }

      // ========== Start Resend Timer ==========
      function startResendTimer() {
        let seconds = 30;
        const resendBtn = document.getElementById("resendBtn");
        resendBtn.disabled = true;

        otpResendTimer = setInterval(() => {
          seconds--;
          resendBtn.textContent = `Resend OTP (${seconds}s)`;

          if (seconds <= 0) {
            clearInterval(otpResendTimer);
            resendBtn.disabled = false;
            resendBtn.textContent = "Resend OTP";
          }
        }, 1000);
      }

      // ========== Start OTP Expiry Timer ==========
      function startOTPExpiryTimer() {
        let minutes = 10;
        let seconds = 0;
        const timerDiv = document.getElementById("otpTimer");

        otpExpiryTimer = setInterval(() => {
          if (seconds === 0) {
            if (minutes === 0) {
              clearInterval(otpExpiryTimer);
              timerDiv.textContent = "OTP Expired - Request a new OTP";
              timerDiv.classList.add("expired");
              document.getElementById("otpCode").disabled = true;
              document.querySelector(".btn-verify-otp").disabled = true;
              return;
            }
            minutes--;
            seconds = 59;
          } else {
            seconds--;
          }

          timerDiv.textContent = `Expires in: ${minutes}:${String(seconds).padStart(2, "0")}`;
        }, 1000);
      }

      // ========== Load Doctors ==========
      function loadDoctors() {
        fetch(`${API_BASE}/doctors/`)
          .then((response) => response.json())
          .then((data) => {
            const select = document.getElementById("doctor");
            select.innerHTML =
              '<option value="">-- Choose a Doctor --</option>';

            data.forEach((doctor) => {
              const option = document.createElement("option");
              option.value = doctor.id;
              option.textContent = `Dr. ${doctor.name} (${doctor.specialty})`;
              select.appendChild(option);
            });

            // Select doctor if provided in URL
            const urlParams = new URLSearchParams(window.location.search);
            const doctorId = urlParams.get("doctor_id");
            if (doctorId) {
              select.value = doctorId;
            }
          })
          .catch((error) => {
            console.error("Error loading doctors:", error);
            showNotification("Failed to load doctors", "error");
          });
      }

      // ========== Submit Appointment ==========
      function submitAppointment(event) {
        event.preventDefault();

        if (!isPhoneVerified) {
          showNotification("Please verify your phone number first", "error");
          return;
        }

        const formData = {
          phone_number: currentPhoneNumber,
          customer_name: document.getElementById("name").value,
          doctor: document.getElementById("doctor").value,
          date: document.getElementById("date").value,
        };

        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = "Booking...";

        fetch(`${API_BASE}/create-appointment/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              showNotification(data.error, "error");
            } else {
              showNotification(
                "Appointment booked successfully! Your Appointment ID: " +
                  data.appointment.id,
                "success",
              );
              setTimeout(() => {
                window.location.href = "/";
              }, 3000);
            }
            submitBtn.disabled = false;
            submitBtn.textContent = "Confirm Appointment";
          })
          .catch((error) => {
            console.error("Error:", error);
            showNotification("Failed to book appointment", "error");
            submitBtn.disabled = false;
            submitBtn.textContent = "Confirm Appointment";
          });
      }

      // ========== Set Minimum Date for Appointment ==========
      document.addEventListener("DOMContentLoaded", function () {
        // Prefill phone number if provided in URL
        const urlParams = new URLSearchParams(window.location.search);
        const phone = urlParams.get("phone");
        if (phone) {
          document.getElementById("phoneNumber").value = phone;
        }

        // Load doctors on page load (only if phone is already verified, but for now load anyway)
        loadDoctors();

        const appointmentInput = document.getElementById("date");

        // Set minimum date to today + 1 hour
        const now = new Date();
        now.setHours(now.getHours() + 1);

        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");

        appointmentInput.min = `${year}-${month}-${day}T${hours}:${minutes}`;
      });
    </script>
  </body>
</html>
